# Deploying Azure Function Using Apache Ignite

## Pre-requisities

Ensure that you use Java 8. Azure Functions doesn't support Java of later versions yet. If you are on MacOs and a default
JDK is 9+, then use this command to switch to Java 8:
`export JAVA_HOME="/Library/Java/JavaVirtualMachines/jdk1.8.0_191.jdk/Contents/Home/"`

## Deploying Ignite Cluster in Azure AKS

### Starting Kubernetes Cluster

* Deploy 2-nodes Kubernetes cluster following instructions from the documentation page:
https://apacheignite.readme.io/docs/microsoft-azure-deployment
* Connect to the Kubernetes cluster and check that the nodes are running: 
https://apacheignite.readme.io/docs/microsoft-azure-deployment#section-access-to-your-kubernetes-cluster

Import resource group credentials: `az aks get-credentials --resource-group ignite-azure-function-demo --name IgniteCluster`

Check that nodes are running: `kubectl get nodes`

TODO: add some screenshots and try to reuse the template generated by Azure.

### Starting Ignite Cluster 

* Go to the `cfg` folder of the project
* Create namespace for the demo: `kubectl create namespace ignite-azure-function-demo`
* Create a service account: `kubectl create sa ignite-azure-function-demo -n ignite-azure-function-demo`
* Create a cluster role and role binding: `kubectl create -f ignite-cluster-role.yaml`
* Deploy Ignite service: `kubectl create -f ignite-service.yaml`
* Confirm the service is running: `kubectl get svc ignite-service --namespace=ignite-azure-function-demo`
* Deploy an Ignite cluster: `kubectl create -f ignite-deployment.yaml`
* Confirm the pods are running (give some time for Azure to deploy the pods): `kubectl get pods -n ignite-azure-function-demo`
* Check the logs to ensure the nodes formed the cluster: `kubectl logs {pod-name} -n ignite-azure-function-demo`

### Connecting to the Ignite Cluster and Loading World Database

Execute this command to get Ignite Service public IP address and open port numbers: 
`kubectl describe svc ignite-service -n ignite-azure-function-demo`

* Check that you can connect to the Rest server: `curl http://{EXTERNEL_IP}:8080/ignite?cmd=version`
* Check that you can execute the compute task: ` curl 'http://{EXTERNAL_IP}:8080/ignite?cmd=exe&name=org.gridgain.demo.azurefunction.compute.AvgCalculationTask'`
* Connect to the cluster with SQLLine: `./sqlline.sh --verbose=true -u jdbc:ignite:thin://13.87.164.252/`
* Load the database: `!run /Users/dmagda/Downloads/gridgain-demos/ignite-azure-function-demo/cfg/ignite_world_db.sql`

## Running the function locally

`mvn clean package -DskipTests`
`mvn azure-functions:run`

## Deploying the function to Azure

* Log in with Azure if needed: `az login` 
* Deploy `mvn azure-functions:deploy`


## Misc

Connect to pod's bash shell:
`kubectl exec -t -i ignite-cluster-7759c665ff-4d4s8 -n ignite-azure-function-demo bash`
